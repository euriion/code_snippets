---
title: "causal_impact"
output: html_document
reference: http://google.github.io/CausalImpact/CausalImpact.html
---

# 구글 causal_impact 패키지 예제

## 개요 (Overall)

predict period와 post period를 입력하면 얼마나 중격(impact)가 있었는지를 찾아주는 것입니다.

## 문제점
원래 이런쪽에서 알아내려하는 문제는 외부요인으로 인해 impact가 생긴 지점이 어디인지 자동으로 찾아내는 문제에 집중합니다.
이 예제에서는 충격(impact)이 발생한 지점을 미리 알아야 한다는 점입니다.
예를 들자면 어떤 판매 회사(retail)에서 프로모션을 했을 때 그 날을 기점으로 매출이 실제로 올랐는지를 판단하기 위한 것입니다.
온라인이라면 TV광고를 했는데 정말 TV가 오른것이 맞는지 확인하는 것입니다.
이것은 사실 왜 필요한 것인가라는 의문를 가질 수 있습니다.  
그 날 이후로 매출이 실제로 올랐으면 오른것이 맞으니까요.
하지만 이런 문제에서 외부 요인이 매우 많고 어떤것이 주영향인지 복합영향인지 확인하기 어렵기 때문에 실제로도 잘 되는지를 확인하는 것은 매우 어려운 문제입니다.  실제로 시계열 분석의 고급단계에서는 이런 매우 어려운 문제를 다루는 것에 집중하고 있다고 합니다. (전공분야가 아니라서 패쓰..'ㅡ')

## 설치

설치합니다. 최신 패키지이므로 cran보다는 소스에서 바로 설치하는 것이 편리합니다.
devtools를 이용해서 github에서 소스를 받아 바로 설치합니다.

```{r}
library(devtools)
devtools::install_github("google/CausalImpact")
# install_github("google/CausalImpact")  # 그냥 이렇게 해도 됩니다.
```
자 라이브러리를 호출해 줍니다.  여기까지는 기본입니다.

```{r}
library(CausalImpact)
```

테스트를 위한 샘플 데이터를 만듭니다. 
arima.sim이라는 함수를 이용해서 arima모델을 이용한 시뮬레이션 데이터를 생성하는 것입니다.
arima는 시계열분석에서 예측 문제에 사용하는 매우 유명한 알고리즘입니다.
arima모델에서 시뮬레이션해서 데이터를 생성했으므로 아마도 예측이 무지 잘 될 것입니다. (실제로는 그렇지 않은 경우가 매우 많습니다)

다음 코드는 예제용 데이터를 생성하는 부분입니다.

```{r}
set.seed(1)  
x1 <- 100 + arima.sim(model=list(ar = 0.999), n=100)
y <- 1.2 * x1 + rnorm(100)
y[71:100] <- y[71:100] + 10
data <- cbind(y, x1)
```
한줄씩 살펴봅니다.

```{r}
set.seed(1)  
```

랜덤생성기를 선택합니다. 1 이면 RNGkind라는 것을 선택히는 것입니다. 자세히 확인하려면 박터지므로 패쓰합니다.

```{r}
x1 <- 100 + arima.sim(model=list(ar = 0.999), n=100)
```

ARIMA 모델을 이용해서 ar 파라미터를 0.999로 주고 100개의 데이터값을 생성합니다.
ar파라미터는 ARIMA 모델에 주어져야할 파라미터중 하나입니다. ar은 Autoregressive 입니다. ARIMA쪽도 어려우므로 설명은 패쓰
위에서 상수 100을 더한 것은 그냥 그래프에 표현할 때 보기 좋으라고 한 것입니다.

```{r}
y <- 1.2 * x1 + rnorm(100)
```
정규분포를 기준으로 100개의 랜덤값을 뽑아냅니다. 그리고 1.2를 곱해줍니다. 
1.2는 변폭을 좀 키우려고 한것으도 보입니다. (시뮬레이션! 시뮬레이션! )
정규분포를 기준으로 하는 것은 시계열모형에서는 변화폭이 정규분프라고 가정하기 때문입니다. (그렇다고 무조건 정규분포라는 말이 아닙니다)
결국 종속변수(Target Variable) y를 생성합니다. 이쁘게!

```{r}
y[71:100] <- y[71:100] + 10
```

자 그리고 생성한 종속변수 뒷쪽 30개에 값을 10씩 더해줍니다. 
즉 71번째 데이터부터는 10씩 영향을 더 받은 것입니다.  
y값을 생성할 때 랜덤요소가 있었기 때문에 균등하게 10씩 받았는지는 데이터만을 볼 때는 확인이 안되게 됩니다.
그리고 그렇다고 하더라도 실제로는 이렇게 균등하게 영향을 받는 경우가 없죠.

```{r}
data <- cbind(y, x1)
```
컬럼 콤바인(cbind)을 해서 2열 100행짜리 행렬로 만듭니다.

```{r}
matplot(data, type="l")
```

자 데이터를 그림으로 살펴봅니다.
type이 "l"인 것은 선그래프를 그려라는 말입니다.
빨간선은 x, 깜장선은 y입니다.  
즉 예측(prediction)값과 실제(actual)값 입니다. 

기본적인 시계열모형은 실제값을 이용해서 모델을 생성한 후 예측값된 값이 실제값에 가깝게 만드는 것입니다.

```{r}
pre.period <- c(1, 70)
post.period <- c(71, 100)
```

이제 영향점을 기준으로 기간을 분할합니다. 앞쪽 70개는 영향받기전 뒤쪽 30개는 영항을 받은 후 입니다.

```{r}
impact <- CausalImpact(data, pre.period, post.period)
```

자 여기가 핵심입니다.
결국 이 코드 한줄입니다.
참고로 CausalImpact 안쪽은 BTS 모델(Bayesian Time Series)로 되어 있습니다. 
(이건 매우 어려우므로 패쓰합니다. 펑션의 소스를 열게되면 판도라의 상자를 열었다는 것을 알게 됩니다)

impact의 결과는 요약으로 볼 수 있는데
CI(Confidence Interval) 신뢰구간입니다.

